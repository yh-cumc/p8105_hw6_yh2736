---
title: "yh2736"
author: "Yongmei Huang"
date: "11/16/2019"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(modelr)
library(purrr)
library(mgcv)

```


```{r, echo = FALSE, message = FALSE, warning = FALSE}
##set the seed
set.seed(1)
```


# Problem 1
```{r, message = FALSE, warning = FALSE}
###Upload the data
birth_weight_dataset <- read_csv(file = "./data/birthweight.csv", 
                                 col_types = cols(
                                   babysex = col_factor(),
                                   frace = col_factor(),
                                   malform = col_factor(),
                                   mrace = col_factor()
                                 )) %>% 
  janitor::clean_names()

###Check missing data and display in table
birth_weight_dataset %>% 
  map_df(~sum(is.na(.x))) %>%
  unnest() %>% 
  pivot_longer(
    babysex:wtgain,
    names_to = "variable",
    values_to = "num_missing_value"
  ) %>% 
  knitr::kable(
    caption = "Table 1 The number of missing data in birthweight data frame"
  ) 



###Summary the dataset
###Define the function "my_summary"
my_summary <- function(x, na.rm=TRUE){
  c(Mean=mean(x, na.rm=na.rm, digits = 0),
    SD=sd(x, na.rm=na.rm),
    Median=median(x, na.rm=na.rm),
    Min=min(x, na.rm=na.rm),
    Max=max(x, na.rm=na.rm), 
    N=length(x))}

###Identity the numeric column
ind <- sapply(birth_weight_dataset, is.numeric)

###Apply "my_summary" to numeric columns only
sapply(birth_weight_dataset[, ind], my_summary) %>%
  t() %>% 
  knitr::kable(
    digits = 2,
    caption = "Table 2 The summary of birth weight dataset"
  ) 
  

```

```{r}
###Using baby's sex and mother's race as predictors
fit1 <-  lm(bwt ~ babysex + mrace, data = birth_weight_dataset) 

###draw the figure1 with lm(bwt ~ babysex + mrace)
birth_weight_dataset %>% 
  modelr::add_residuals(fit1) %>% 
  modelr::add_predictions(fit1) %>% 
  ggplot(aes(x = pred, y = resid)) +
  geom_point() + 
  xlab("Prediction") +
  ylab("Residual") +
  theme(
    axis.title.x = element_text(size = 12, 
                                color = "red"),
    axis.title.y = element_text(size = 12, 
                                color = "red"),
    axis.text.x = element_text(angle = 60)
  ) +
  labs(
    title = "figure 1 lm(bwt ~ babysex + mrace) "
  )

```



```{r, message = FALSE, warning = FALSE}
###Using length at birth and gestational age as predictors
fit2 <- lm(bwt ~ blength + gaweeks, data = birth_weight_dataset)

###Draw a plot 
birth_weight_dataset %>% 
  modelr::add_residuals(fit2) %>% 
  modelr::add_predictions(fit2) %>% 
  ggplot(aes(x = pred, y = resid)) +
  geom_point() + 
  xlab("Prediction") +
  ylab("Residual") +
  theme(
    axis.title.x = element_text(size = 12, 
                                color = "red"),
    axis.title.y = element_text(size = 12, 
                                color = "red"),
    axis.text.x = element_text(angle = 60)
  ) +
  labs(
    title = "figure 2lm(bwt ~ blength + gaweeks) "
  )


```


```{r, message = FALSE, warning = FALSE}
###using head circumference, length, sex, and all interactions (including the three-way interaction)
fit3 <- lm(bwt ~ bhead * blength * babysex, data = birth_weight_dataset)

###Draw a plot 
birth_weight_dataset %>% 
  modelr::add_residuals(fit3) %>% 
  modelr::add_predictions(fit3) %>% 
  ggplot(aes(x = pred, y = resid)) +
  geom_point() + 
  xlab("Prediction") +
  ylab("Residual") +
  theme(
    axis.title.x = element_text(size = 12, 
                                color = "red"),
    axis.title.y = element_text(size = 12, 
                                color = "red"),
    axis.text.x = element_text(angle = 60)
  ) +
  labs(
    title = "figure 3 lm(bwt ~ bhead * blength * babysex) "
  )


```


```{r, message = FALSE, warning = FALSE}
###Get the rmse value
cv_birth_weight <- crossv_mc(birth_weight_dataset, 100) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)
  ) %>% 
  mutate(
    linear_mode1 = map(train, ~lm(bwt ~ babysex + mrace, data = .x)),
    linear_mode2 = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
    linear_mode3 = map(train, ~lm(bwt ~ bhead * blength * babysex, data = .x))
  ) %>% 
  mutate(
    rmse_linear_mode1 = map2_dbl(linear_mode1, test, ~rmse(model = .x, data = .y)),
    rmse_linear_mode2 = map2_dbl(linear_mode2, test, ~rmse(model = .x, data = .y)),
    rmse_linear_mode3 = map2_dbl(linear_mode3, test, ~rmse(model = .x, data = .y))
  )


###Draw a plot to shows the distribution of RMSE values for each candidate model.
cv_birth_weight %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model",
    values_to = "rmse",
    names_prefix = "rmse_"
  ) %>% 
  ggplot(aes(x = model, y = rmse)) +
  geom_violin()

```

